# v1.3 Anonymous Data Collection - Implementation Summary

## What We Built

Silent, anonymous song data collection that runs in the background to build a community database for future premium features.

## Files Created/Modified

### New Files:
1. **`SUPABASE_SETUP.md`** - Complete setup guide for Supabase database
2. **`netlify/functions/community-contribute.js`** - Netlify function to accept contributions
3. **`ios/GuitarSongbook/GuitarSongbook/Services/CommunityDataService.swift`** - iOS service for submitting data

### Modified Files:
1. **`package.json`** - Added `@supabase/supabase-js` dependency
2. **`ios/GuitarSongbook/GuitarSongbook/Views/AddSongView.swift`** - Integrated silent submission
3. **`ios/GuitarSongbook/GuitarSongbook/Views/MainTabView.swift`** - Added Settings toggle

## How It Works

### User Flow:
1. User adds a song from Spotify (as normal)
2. User saves the song
3. **Silently in background:** Song data is anonymously submitted to Supabase
4. No UI feedback - completely invisible to user
5. User can opt-out in Settings â†’ Community â†’ "Share Songs Anonymously"

### What Data Is Collected:
- Spotify Track ID
- Song title & artist
- Chords array
- Capo position
- Tuning
- Notes (optional)

### What Is NOT Collected:
- User identity
- Device ID
- Personal information
- Songs without Spotify URLs (manual entries)

## Deployment Steps

### 1. Set Up Supabase (One-Time Setup)

Follow the instructions in `SUPABASE_SETUP.md`:
1. Create Supabase project at https://supabase.com
2. Run the SQL schema in Supabase SQL Editor
3. Get your credentials:
   - `SUPABASE_URL`
   - `SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_KEY`

### 2. Deploy Backend

```bash
# Install dependencies
cd /Users/akaminsky/code/akaminsky.github.io/ai/guitar
npm install

# Add environment variables to Netlify
# Go to Netlify dashboard â†’ Site Configuration â†’ Environment Variables
# Add:
#   SUPABASE_URL = https://xxxxx.supabase.co
#   SUPABASE_ANON_KEY = eyJhbGc...
#   SUPABASE_SERVICE_KEY = eyJhbGc...

# Deploy
git add .
git commit -m "Add v1.3 anonymous data collection"
git push

# Netlify will auto-deploy the new function
```

### 3. Test the Function

```bash
# Test the Netlify function directly
curl -X POST https://fretnot.netlify.app/.netlify/functions/community-contribute \
  -H "Content-Type: application/json" \
  -d '{
    "spotifyTrackId": "2CT3r93YuSHtm57mjxvjhH",
    "songTitle": "Test Song",
    "artist": "Test Artist",
    "chords": ["C", "G", "Am", "F"],
    "capo": 2,
    "tuning": "EADGBE",
    "notes": "Test note"
  }'

# Should return: {"success":true,"message":"Contribution saved anonymously","contributionId":"..."}
```

### 4. Build & Test iOS App

1. Open Xcode project
2. Build and run on simulator or device
3. Add a song from Spotify (with chords)
4. Save the song
5. Check Xcode console for: `ðŸ“Š Anonymous contribution submitted successfully`

### 5. Verify Data Collection

Go to Supabase dashboard:
1. Click "Table Editor" in sidebar
2. Click `song_contributions` table
3. You should see your test contribution!

Or run this SQL in SQL Editor:
```sql
SELECT COUNT(*) FROM song_contributions;
SELECT * FROM song_contributions ORDER BY created_at DESC LIMIT 10;
```

## Testing Checklist

- [ ] Supabase project created and schema deployed
- [ ] Environment variables added to Netlify
- [ ] Backend deployed (Netlify function accessible)
- [ ] Function test (curl) returns success
- [ ] iOS app builds without errors
- [ ] Add Spotify song with chords â†’ saves successfully
- [ ] Check Xcode console â†’ see "ðŸ“Š Anonymous contribution submitted successfully"
- [ ] Check Supabase Table Editor â†’ contribution appears in database
- [ ] Test opt-out: Settings â†’ Turn OFF "Share Songs Anonymously"
- [ ] Add another song â†’ should see "ðŸ“Š Anonymous sharing disabled by user"
- [ ] No contributions appear in database while opted out

## Privacy Compliance

### App Store Privacy Updates Needed:

1. **App Privacy Section** in App Store Connect:
   - Add "Product Interaction" data type
   - Mark as "Not linked to user"
   - Purpose: "App Functionality"

2. **Privacy Policy Update**:
   Add this section:
   ```
   Anonymous Data Collection

   When you add songs from Spotify, Fret Not may anonymously collect your chord
   data to improve the app experience for all users. This includes:
   - Song chords, capo position, and tuning
   - Song title and artist (from Spotify)

   We do NOT collect:
   - Your identity or personal information
   - Device identifiers
   - Songs added manually (without Spotify)

   You can opt out anytime in Settings â†’ Community â†’ Share Songs Anonymously.
   All data is stored securely and used only for improving the app.
   ```

## Monitoring & Analytics

### Check Data Growth:

```sql
-- Total contributions
SELECT COUNT(*) as total_contributions FROM song_contributions;

-- Contributions per day
SELECT
  DATE(created_at) as date,
  COUNT(*) as contributions
FROM song_contributions
GROUP BY DATE(created_at)
ORDER BY date DESC
LIMIT 30;

-- Most contributed songs
SELECT
  song_title,
  artist_name,
  COUNT(*) as times_contributed
FROM song_contributions
GROUP BY song_title, artist_name
ORDER BY times_contributed DESC
LIMIT 20;

-- Unique songs
SELECT COUNT(DISTINCT spotify_track_id) as unique_songs FROM song_contributions;
```

## Success Metrics

### Week 1 Goals:
- 50+ anonymous contributions
- 30+ unique songs
- <1% error rate in Netlify function logs

### Month 1 Goals:
- 500+ contributions
- 300+ unique songs
- Data for top 50 popular songs

### By Premium Launch (v1.4):
- 2000+ contributions
- 1000+ unique songs
- Rich dataset to power premium suggestions

## Troubleshooting

### "Failed to save contribution" in logs:
- Check Supabase credentials in Netlify env vars
- Verify Supabase project is active
- Check Row Level Security policies are correct

### No console logs in Xcode:
- Make sure you're running in Debug mode
- Check that submission isn't being skipped (no Spotify URL, opted out)

### Contributions not appearing in Supabase:
- Check Netlify function logs for errors
- Verify network connectivity
- Test the function directly with curl

## Next Steps (v1.4 Premium Feature)

When ready to launch premium:
1. Set up Sign in with Apple
2. Create PaywallView
3. Add CommunityDataService fetch methods
4. Build UI to display community suggestions
5. Add voting system
6. Launch premium tier!

---

**Status:** Ready for Supabase setup and deployment!
**Estimated Time:** 1-2 hours to complete all setup and testing
